name: CI-CD for BMS App

on:
  push:
    branches:
      - main

env:
  IMAGE_NAME: bms-app

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout Code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2️⃣ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3️⃣ Install Dependencies & Build
      - name: Install & Build
        run: |
          npm install
          npm run build

      # 4️⃣ Install Trivy & Pull ZAP Image
      - name: Install Trivy & Pull ZAP Image
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sudo sh -s -- -b /usr/local/bin
          docker pull zaproxy/zap-stable:latest
          mkdir -p $HOME/.trivy/templates
          curl -sL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl \
            -o $HOME/.trivy/templates/html.tpl
          chmod 644 $HOME/.trivy/templates/html.tpl

      # 5️⃣ Trivy FS Scan
      - name: Trivy FS Scan
        run: |
          trivy fs --format template \
            --template "@$HOME/.trivy/templates/html.tpl" \
            -o trivy-fs-report.html .

      # 6️⃣ Build Docker Image
      - name: Build Docker Image
        run: docker build -t $IMAGE_NAME:latest .

      # 7️⃣ Trivy Docker Image Scan
      - name: Trivy Image Scan
        run: |
          trivy image --format template \
            --template "@$HOME/.trivy/templates/html.tpl" \
            -o trivy-image-report.html $IMAGE_NAME:latest

      # 8️⃣ OWASP ZAP Scan
      - name: Run OWASP ZAP Scan
        run: |
          docker run --rm -v $(pwd):/zap/wrk/:rw \
            zaproxy/zap-stable zap-baseline.py \
            -t http://localhost:3000 \
            -x zap_report.xml || true
          xsltproc /usr/share/xml/docbook/stylesheet/docbook-xsl/html/docbook.xsl zap_report.xml > zap_report.html || echo "ZAP HTML conversion skipped"

      # 9️⃣ Upload Security Reports
      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            trivy-fs-report.html
            trivy-image-report.html
            zap_report.html
